# =============================================================================
# Hive Warden Demo â€” Fresh standalone install simulation
# =============================================================================
# Runs on different ports (8080/8081) with a separate database volume.
# Simulates what a first-time beekeeper sees after downloading.
#
#   docker compose -f docker-compose.demo.yml -p hivewarden up -d
#   Open http://localhost:8081
#
# To tear down (including data):
#   docker compose -f docker-compose.demo.yml -p hivewarden down -v
# =============================================================================

services:
  db:
    image: yugabytedb/yugabyte:2024.2.7.2-b1
    command: bin/yugabyted start --daemon=false --advertise_address=db
    volumes:
      - hivewarden_data:/home/yugabyte/data
    environment:
      - YSQL_USER=yugabyte
      - YSQL_PASSWORD=hivewarden-demo-db
      - YSQL_DB=yugabyte
    healthcheck:
      test: ["CMD", "bin/yugabyted", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - hivewarden

  db-init:
    image: postgres:16-alpine
    volumes:
      - ./scripts/init-yugabytedb.sh:/init-yugabytedb.sh:ro
    environment:
      - YSQL_HOST=db
      - YSQL_PORT=5433
      - YSQL_USER=yugabyte
      - YSQL_PASSWORD=hivewarden-demo-db
      - APIS_DB_USER=apis
      - APIS_DB_PASSWORD=hivewarden-demo-app
    entrypoint: ["/bin/sh", "/init-yugabytedb.sh"]
    depends_on:
      db:
        condition: service_healthy
    networks:
      - hivewarden
    restart: "no"

  server:
    build:
      context: ./apis-server
      dockerfile: Dockerfile
    ports:
      - "8080:3000"
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /data:size=500M,mode=1777
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      - PORT=3000
      - DEPLOYMENT_MODE=standalone
      - AUTH_MODE=local
      - SECRETS_BACKEND=env
      - MULTI_TENANT=false
      - DISABLE_AUTH=false
      - GO_ENV=production
      - YSQL_HOST=db
      - YSQL_PORT=5433
      - YSQL_DB=apis
      - YSQL_USER=apis
      - YSQL_PASSWORD=hivewarden-demo-app
      - JWT_SECRET=hivewarden-demo-jwt-secret-change-me-in-production-please-64chars!!
      - CORS_ALLOWED_ORIGINS=http://localhost:8081,http://localhost:8080
    volumes:
      - ./secrets:/secrets:ro
    command: ["/app/apis-server"]
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      db-init:
        condition: service_completed_successfully
    networks:
      - hivewarden

  dashboard:
    build:
      context: ./apis-dashboard
      dockerfile: Dockerfile.dev
    ports:
      - "8081:5173"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    volumes:
      - ./apis-dashboard:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8080/api
      - VITE_AUTH_MODE=local
      - VITE_DEV_MODE=false
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:5173 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - hivewarden

networks:
  hivewarden:
    driver: bridge

volumes:
  hivewarden_data:
