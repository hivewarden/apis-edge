# Story 8.1: BeeBrain Rule Engine (MVP)

Status: review

## Story

As a **system**,
I want a rule-based analysis engine,
So that BeeBrain can generate insights without ML models.

## Acceptance Criteria

1. **Given** the BeeBrain engine runs **When** it analyzes hive data **Then** it applies predefined rules to detect patterns:
   - Queen aging: queen_age > 2 years + productivity_drop > 20%
   - Treatment due: days_since_treatment > 90
   - Inspection overdue: days_since_inspection > 14
   - Hornet correlation: high_detection_count + specific_time_window
   - Weight anomaly: sudden_weight_change > threshold (future - requires sensor data)

2. **Given** a rule matches **When** the insight is generated **Then** it includes:
   - Severity: info, warning, or action-needed
   - Message: Human-readable description
   - Suggested action: Actionable next step
   - Data points: Supporting evidence from the data

3. **Given** no rules match **When** analysis completes **Then** BeeBrain returns: "All looks good. No actions needed."

4. **Given** rules are defined in a config file **When** the config file is updated **Then** new rules take effect on next analysis run (no server restart required)

5. **Given** analysis is triggered **When** it completes **Then** insights are stored in the `insights` table with:
   - tenant_id, hive_id (optional), rule_id, severity, message, suggested_action, data_points, created_at, dismissed_at (null initially)

## Tasks / Subtasks

### Task 1: Database Schema (AC: #5)
- [x] 1.1 Create migration `0015_insights.sql` with `insights` table
- [x] 1.2 Add indexes for tenant_id, hive_id, created_at lookups
- [x] 1.3 Add RLS policy for tenant isolation
- [x] 1.4 Test migration runs cleanly

### Task 2: Rules Configuration (AC: #4)
- [x] 2.1 Create `internal/beebrain/rules.yaml` with predefined rules
- [x] 2.2 Define rule schema: id, name, description, condition (type + params), severity, message_template, suggested_action
- [x] 2.3 Create `internal/beebrain/config.go` to parse and load rules from YAML
- [x] 2.4 Implement hot-reload: detect file changes and reload rules without restart

### Task 3: BeeBrain Service Core (AC: #1, #2, #3)
- [x] 3.1 Create `internal/services/beebrain.go` with rule engine logic
- [x] 3.2 Implement `AnalyzeHive(ctx, conn, hiveID)` - analyzes single hive
- [x] 3.3 Implement `AnalyzeTenant(ctx, conn, tenantID)` - analyzes all hives for tenant
- [x] 3.4 Implement rule evaluation functions for each rule type:
  - [x] 3.4.1 `evaluateQueenAging` - checks queen age and productivity
  - [x] 3.4.2 `evaluateTreatmentDue` - checks days since last treatment
  - [x] 3.4.3 `evaluateInspectionOverdue` - checks days since last inspection
  - [x] 3.4.4 `evaluateHornetCorrelation` - checks detection patterns
- [x] 3.5 Implement "all looks good" response when no rules match

### Task 4: Insights Storage Layer (AC: #5)
- [x] 4.1 Create `internal/storage/insights.go` with CRUD operations
- [x] 4.2 Implement `CreateInsight`, `ListInsightsByHive`, `ListInsightsByTenant`
- [x] 4.3 Implement `GetInsightByID`, `DismissInsight`, `SnoozeInsight`
- [x] 4.4 Implement `DeleteOldInsights` for cleanup (insights > 90 days)

### Task 5: Backend API Handlers (AC: #1, #2, #3, #5)
- [x] 5.1 Create `internal/handlers/beebrain.go` with REST endpoints
- [x] 5.2 Implement `GET /api/beebrain/dashboard` - returns tenant-wide analysis summary
- [x] 5.3 Implement `GET /api/beebrain/hive/{id}` - returns hive-specific analysis
- [x] 5.4 Implement `POST /api/beebrain/refresh` - triggers new analysis
- [x] 5.5 Implement `POST /api/beebrain/insights/{id}/dismiss` - dismisses an insight
- [x] 5.6 Implement `POST /api/beebrain/insights/{id}/snooze` - snoozes an insight
- [x] 5.7 Register routes in main.go

### Task 6: Testing (AC: #1, #2, #3, #4, #5)
- [x] 6.1 Create `apis-server/tests/services/beebrain_test.go` - unit tests for rule engine
- [x] 6.2 Create `apis-server/tests/storage/insights_test.go` - storage layer tests
- [x] 6.3 Create `apis-server/tests/handlers/beebrain_test.go` - API endpoint tests
- [x] 6.4 Test rule hot-reload functionality

## Dev Notes

### Architecture Patterns (from CLAUDE.md and architecture.md)

**Database Schema** (new table for insights):
```sql
-- Insights generated by BeeBrain
CREATE TABLE insights (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id TEXT NOT NULL REFERENCES tenants(id),
    hive_id TEXT REFERENCES hives(id),  -- NULL for tenant-wide insights
    rule_id TEXT NOT NULL,              -- References rule from rules.yaml
    severity TEXT NOT NULL,             -- 'info', 'warning', 'action-needed'
    message TEXT NOT NULL,
    suggested_action TEXT,
    data_points JSONB DEFAULT '{}',     -- Evidence supporting the insight
    created_at TIMESTAMPTZ DEFAULT NOW(),
    dismissed_at TIMESTAMPTZ,           -- NULL if not dismissed
    snoozed_until TIMESTAMPTZ           -- NULL if not snoozed
);

-- RLS Policy
ALTER TABLE insights ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON insights
    USING (tenant_id = current_setting('app.tenant_id'));

CREATE INDEX idx_insights_tenant ON insights(tenant_id);
CREATE INDEX idx_insights_hive ON insights(hive_id);
CREATE INDEX idx_insights_created ON insights(created_at DESC);
CREATE INDEX idx_insights_active ON insights(tenant_id, dismissed_at, snoozed_until);
```

**Rules Configuration Format** (`internal/beebrain/rules.yaml`):
```yaml
# BeeBrain Rule Engine Configuration
# Rules are evaluated in order, all matching rules generate insights
# Rules can be added/modified without server restart (hot-reload)

rules:
  - id: queen_aging
    name: Queen Aging Alert
    description: Detects queens over 2 years old with productivity decline
    condition:
      type: queen_age_productivity
      params:
        min_queen_age_years: 2
        productivity_drop_percent: 20
    severity: warning
    message_template: "Queen in {{hive_name}} is {{queen_age}} old and productivity has dropped {{drop_percent}}% compared to last season."
    suggested_action: "Consider requeening in spring or monitoring closely for supersedure signs."

  - id: treatment_due
    name: Treatment Due Reminder
    description: Alerts when days since last treatment exceeds threshold
    condition:
      type: days_since_treatment
      params:
        max_days: 90
    severity: action-needed
    message_template: "{{hive_name}}: Varroa treatment due ({{days}} days since last treatment)"
    suggested_action: "Schedule varroa treatment within the next week."

  - id: inspection_overdue
    name: Inspection Overdue
    description: Alerts when days since last inspection exceeds threshold
    condition:
      type: days_since_inspection
      params:
        max_days: 14
    severity: info
    message_template: "{{hive_name}}: Consider inspection ({{days}} days since last)"
    suggested_action: "Schedule an inspection to check hive health."

  - id: hornet_activity_spike
    name: Hornet Activity Spike
    description: Detects unusual increase in hornet detections
    condition:
      type: detection_spike
      params:
        window_hours: 24
        threshold_multiplier: 2.0  # 2x the 7-day average
    severity: warning
    message_template: "Unusual hornet activity detected: {{count}} detections in last 24h ({{multiplier}}x normal)"
    suggested_action: "Check APIS unit footage and consider protective measures."
```

**Handler Pattern** (follow existing patterns from hives.go, treatments.go):
```go
// Follow the exact pattern from hives.go:
// - Use storage.RequireConn(r.Context()) for DB connection
// - Use middleware.GetTenantID(r.Context()) for multi-tenant
// - Use chi.URLParam(r, "id") for route params
// - Use respondJSON/respondError for responses
// - Use zerolog for structured logging
```

**API Response Format** (from architecture.md):
```json
// Dashboard Analysis Response
{
  "data": {
    "summary": "All quiet at your apiary. Your 3 hives are doing well.",
    "last_analysis": "2026-01-25T10:30:00Z",
    "insights": [
      {
        "id": "ins-123",
        "hive_id": "hive-456",
        "hive_name": "Hive 2",
        "rule_id": "treatment_due",
        "severity": "action-needed",
        "message": "Hive 2: Varroa treatment due (92 days since last treatment)",
        "suggested_action": "Schedule varroa treatment within the next week.",
        "data_points": {
          "days_since_treatment": 92,
          "last_treatment_date": "2025-10-25",
          "last_treatment_type": "oxalic_acid"
        },
        "created_at": "2026-01-25T10:30:00Z"
      }
    ],
    "all_good": false
  }
}

// All Good Response
{
  "data": {
    "summary": "All looks good. No actions needed.",
    "last_analysis": "2026-01-25T10:30:00Z",
    "insights": [],
    "all_good": true
  }
}
```

### Service Architecture

**BeeBrain Service** (`internal/services/beebrain.go`):
```go
// BeeBrainService handles rule-based hive analysis
type BeeBrainService struct {
    rules      []Rule
    rulesPath  string
    lastLoaded time.Time
    mu         sync.RWMutex
}

// Rule represents a single analysis rule
type Rule struct {
    ID              string            `yaml:"id"`
    Name            string            `yaml:"name"`
    Description     string            `yaml:"description"`
    Condition       RuleCondition     `yaml:"condition"`
    Severity        string            `yaml:"severity"`
    MessageTemplate string            `yaml:"message_template"`
    SuggestedAction string            `yaml:"suggested_action"`
}

// RuleCondition defines how to evaluate the rule
type RuleCondition struct {
    Type   string                 `yaml:"type"`
    Params map[string]interface{} `yaml:"params"`
}

// Insight represents an analysis result
type Insight struct {
    ID              string                 `json:"id"`
    HiveID          *string                `json:"hive_id,omitempty"`
    HiveName        *string                `json:"hive_name,omitempty"`
    RuleID          string                 `json:"rule_id"`
    Severity        string                 `json:"severity"`
    Message         string                 `json:"message"`
    SuggestedAction string                 `json:"suggested_action"`
    DataPoints      map[string]interface{} `json:"data_points"`
    CreatedAt       time.Time              `json:"created_at"`
}

// AnalysisResult contains the result of BeeBrain analysis
type AnalysisResult struct {
    Summary      string    `json:"summary"`
    LastAnalysis time.Time `json:"last_analysis"`
    Insights     []Insight `json:"insights"`
    AllGood      bool      `json:"all_good"`
}
```

**Rule Evaluation Functions**:
Each rule type needs a dedicated evaluation function:

1. **queen_age_productivity**: Query queen_introduced_at from hives, calculate age, compare harvest data year-over-year
2. **days_since_treatment**: Query last treatment from treatments table, calculate days since
3. **days_since_inspection**: Query last inspection from inspections table, calculate days since
4. **detection_spike**: Query detection counts from detections table, compare to 7-day average

### Data Dependencies

BeeBrain needs to query these existing tables:
- `hives` - Queen age, hive names
- `inspections` - Last inspection date
- `treatments` - Last treatment date
- `harvests` - Productivity comparison (year-over-year)
- `detections` - Hornet detection patterns

**Key Queries**:
```sql
-- Days since last inspection for a hive
SELECT EXTRACT(EPOCH FROM NOW() - MAX(inspected_at)) / 86400 AS days
FROM inspections WHERE hive_id = $1;

-- Days since last treatment for a hive
SELECT EXTRACT(EPOCH FROM NOW() - MAX(treated_at)) / 86400 AS days
FROM treatments WHERE hive_id = $1;

-- Queen age in years for a hive
SELECT EXTRACT(EPOCH FROM NOW() - queen_introduced_at) / 31536000 AS years
FROM hives WHERE id = $1 AND queen_introduced_at IS NOT NULL;

-- Detection count in last 24 hours vs 7-day average
WITH recent AS (
    SELECT COUNT(*) as count_24h
    FROM detections
    WHERE unit_id IN (SELECT unit_id FROM unit_hives WHERE hive_id = $1)
    AND timestamp > NOW() - INTERVAL '24 hours'
),
average AS (
    SELECT COUNT(*)::float / 7 as avg_daily
    FROM detections
    WHERE unit_id IN (SELECT unit_id FROM unit_hives WHERE hive_id = $1)
    AND timestamp > NOW() - INTERVAL '7 days'
)
SELECT recent.count_24h, average.avg_daily,
       CASE WHEN average.avg_daily > 0
            THEN recent.count_24h / average.avg_daily
            ELSE 0 END AS multiplier
FROM recent, average;
```

### Project Structure Notes

**Backend files to create:**
- `apis-server/internal/storage/migrations/0015_insights.sql`
- `apis-server/internal/storage/insights.go`
- `apis-server/internal/beebrain/rules.yaml`
- `apis-server/internal/beebrain/config.go`
- `apis-server/internal/services/beebrain.go`
- `apis-server/internal/handlers/beebrain.go`

**Backend files to modify:**
- `apis-server/cmd/server/main.go` (add BeeBrain routes, initialize service)

**Test files to create:**
- `apis-server/tests/services/beebrain_test.go`
- `apis-server/tests/storage/insights_test.go`
- `apis-server/tests/handlers/beebrain_test.go`

### Key Implementation Details

**API Endpoints:**
```
GET    /api/beebrain/dashboard           - Tenant-wide analysis summary
GET    /api/beebrain/hive/{id}           - Hive-specific analysis
POST   /api/beebrain/refresh             - Trigger new analysis
POST   /api/beebrain/insights/{id}/dismiss - Dismiss an insight
POST   /api/beebrain/insights/{id}/snooze  - Snooze an insight (query: ?days=7)
```

**Dashboard Response Structure:**
```json
{
  "data": {
    "summary": "string",
    "last_analysis": "2026-01-25T10:30:00Z",
    "insights": [...],
    "all_good": boolean
  }
}
```

**Hive Analysis Response Structure:**
```json
{
  "data": {
    "hive_id": "string",
    "hive_name": "string",
    "health_assessment": "string",
    "insights": [...],
    "recommendations": ["string"],
    "last_analysis": "2026-01-25T10:30:00Z"
  }
}
```

### Hot-Reload Implementation

The rules.yaml file should be watched for changes:
```go
// Check file modification time on each request (simple approach)
// Or use fsnotify for file watching (more sophisticated)
func (s *BeeBrainService) getRules() []Rule {
    s.mu.RLock()
    stat, err := os.Stat(s.rulesPath)
    if err == nil && stat.ModTime().After(s.lastLoaded) {
        s.mu.RUnlock()
        s.reloadRules()
        s.mu.RLock()
    }
    rules := s.rules
    s.mu.RUnlock()
    return rules
}
```

### Severity Levels

| Severity | Description | UI Treatment |
|----------|-------------|--------------|
| `info` | Informational, no immediate action needed | Blue icon, lower priority |
| `warning` | Should be addressed soon | Yellow/orange icon, medium priority |
| `action-needed` | Requires immediate attention | Red icon, high priority |

### Message Template Variables

Templates support these variables:
- `{{hive_name}}` - Name of the hive
- `{{queen_age}}` - Human-readable queen age (e.g., "2 years 3 months")
- `{{days}}` - Number of days for time-based rules
- `{{count}}` - Detection count for spike rules
- `{{multiplier}}` - Detection multiplier vs average
- `{{drop_percent}}` - Productivity drop percentage

### References

- [Source: architecture.md#BeeBrain-Service] - BeeBrain service architecture
- [Source: architecture.md#Complete-API-Endpoints] - API endpoint definitions
- [Source: epics.md#Story-8.1] - Full acceptance criteria
- [Source: hives.go] - Handler pattern reference
- [Source: treatments.go] - Storage pattern reference
- [Source: weather.go] - Service pattern reference with caching

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Build successful: `go build ./...`
- All tests pass: `go test ./... -v`

### Completion Notes List

1. **Task 1 - Database Schema**: Created `0015_insights.sql` migration with insights table, RLS policy for tenant isolation, and indexes for efficient querying (tenant_id, hive_id, created_at, rule_id, and composite active insights index).

2. **Task 2 - Rules Configuration**: Created `internal/beebrain/rules.yaml` with 4 predefined rules (queen_aging, treatment_due, inspection_overdue, hornet_activity_spike). Created `internal/beebrain/config.go` with RulesLoader that supports hot-reload by checking file modification time.

3. **Task 3 - BeeBrain Service Core**: Created `internal/services/beebrain.go` with full rule engine including:
   - AnalyzeTenant - analyzes all hives for a tenant
   - AnalyzeHive - analyzes a single hive
   - GetDashboardAnalysis - returns cached active insights
   - Four rule evaluators: evaluateQueenAging, evaluateTreatmentDue, evaluateInspectionOverdue, evaluateHornetCorrelation
   - "All looks good" response when no issues detected
   - Health assessment generation for hive analysis

4. **Task 4 - Insights Storage Layer**: Created `internal/storage/insights.go` with:
   - CreateInsight, GetInsightByID, ListInsightsByHive, ListInsightsByTenant
   - ListActiveInsights (filters dismissed and snoozed)
   - DismissInsight, SnoozeInsight
   - DeleteOldInsights for cleanup
   - CountActiveInsights for dashboard summaries
   - Added GetDetectionSpikeData to detections.go for hornet correlation rule

5. **Task 5 - Backend API Handlers**: Created `internal/handlers/beebrain.go` with:
   - GET /api/beebrain/dashboard
   - GET /api/beebrain/hive/{id}
   - POST /api/beebrain/refresh
   - POST /api/beebrain/insights/{id}/dismiss
   - POST /api/beebrain/insights/{id}/snooze (supports ?days=N query param)
   - Updated main.go to initialize BeeBrain service and register routes

6. **Task 6 - Testing**: Created comprehensive tests:
   - `tests/services/beebrain_test.go` - 14 tests covering rules loader, hot-reload, service creation, struct validation
   - `tests/storage/insights_test.go` - 7 tests covering insight structs, severity values, data points
   - `tests/handlers/beebrain_test.go` - 11 tests covering API response structures, validation

### File List

**New Files Created:**
- `apis-server/internal/storage/migrations/0015_insights.sql`
- `apis-server/internal/beebrain/rules.yaml`
- `apis-server/internal/beebrain/config.go`
- `apis-server/internal/services/beebrain.go`
- `apis-server/internal/storage/insights.go`
- `apis-server/internal/handlers/beebrain.go`
- `apis-server/tests/services/beebrain_test.go`
- `apis-server/tests/storage/insights_test.go`
- `apis-server/tests/handlers/beebrain_test.go`

**Modified Files:**
- `apis-server/cmd/server/main.go` - Added BeeBrain service initialization and routes
- `apis-server/internal/storage/detections.go` - Added GetDetectionSpikeData function

## Change Log

- 2026-01-25: Implemented BeeBrain Rule Engine MVP (Story 8.1)
  - Database schema with insights table and RLS
  - Rules configuration with YAML hot-reload
  - BeeBrain service with 4 rule types
  - Storage layer for insights CRUD
  - REST API handlers for dashboard, hive analysis, refresh, dismiss, snooze
  - Comprehensive unit tests
